!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):((t="undefined"!=typeof globalThis?globalThis:t||self).flowplayer=t.flowplayer||{},t.flowplayer.ovp=e())}(this,(function(){"use strict";const t=t=>"object"==typeof t&&null!==t&&!Array.isArray(t),e=(...n)=>n.reduce((n,r)=>t(r)?(Object.keys(r).forEach(o=>{if(t(n[o])&&t(r[o]))return n[o]=e(n[o],r[o]);n[o]=r[o]}),n):n,{}),n=[].slice;function r(){}function o(t,e,...n){for(const n in e)t[n]=e[n];return t}function i(...t){return t.slice(1).reduce((t,e)=>o(t,e),t[0]||{})}function a(t){return Array.isArray(t)?t.slice(0):t.split(".")}function s(t,e,n){const r=a(e);for(;r.length;){if(null==t)return n;const e=r.shift();if("string"!=typeof e)return n;t=t[e]}return null==t?n:t}function c(t,e,n){const r=(e=a(e)).pop(),o=s(t,e);return o&&r&&(o[r]=n),t}function u(t){const e="number"==typeof t?t:parseInt(t,10);return(e>9?"":"0")+e}function l(t){return"function"==typeof t}function f(){throw new Error("Function was expected as Argument[0]")}var d=[].slice;function p(t){if(!(this instanceof p))return new p(t);var e=this;return e.data=t,e.tap=function(){var t=d.call(arguments),n=t.shift();return n==p.lift?e.data:l(n)?(n.apply(e,[e.data].concat(t)),e):void f()},e.into=e.fmap=function(){var t=d.call(arguments),n=t.shift();return n==p.lift?e.data:l(n)?p(n.apply(e,[e.data].concat(t))):void f()},e.unwrap=function(){return e.data},e}p.of=p,p.lift=function(t){return t instanceof p?t.data:t},p._apply=p.apply=function(t,e){if(0==e.length)return t();if(1==e.length)return t(e[0]);if(2==e.length)return t(e[0],e[1]);if(3==e.length)return t(e[0],e[1],e[2]);if(4==e.length)return t(e[0],e[1],e[2],e[3]);if(5==e.length)return t(e[0],e[1],e[2],e[3],e[4]);throw new Error("Pipe._apply() does not support arity > 5")},p.maybe=function(t,e,n){return t?p._apply(e,[t].concat(d.call(arguments,2,arguments.length))):t},p.curry=function(t,e,n){return(e=e||[]).length>t.length-1?t.apply(n,e):function(){var r=e.concat(d.call(arguments));return p.curry(t,r,n)}};var m=[].slice,v=Array.isArray;function y(t){return t&&"object"==typeof t&&"[object RegExp]"!==Object.prototype.toString.call(t)&&"[object Date]"!==Object.prototype.toString.call(t)}function h(t,e){return t.length===t.filter(e).length}function _(){return h(m.call(arguments),v)}function g(t,e){for(var n in t)e(n,t[n])}function w(t){return y(t)?v(t)?t.map(w):E({},t):t}function b(t,e){var n={};return g(t,(function(t,e){n[t]=w(e)})),function(t,e){return g(e,(function(e,n){if(void 0===t[e])return t[e]=w(n);t[e]=E(t[e],n)})),t}(n,e)}function E(t,e){return _(t,e)?function(t){return w(t)}(t):!1===t?t:!0===t&&!1!==e||!y(t)&&y(e)?e:void 0===t||y(t)?y(t)&&!y(e)?t:function(){return h(m.call(arguments),y)}(t,e)?b(t,e):void 0:t}function O(){return[].reduce.call(arguments,(function(t,e){return E(t,e)}),_.apply(null,arguments)?[]:{})}function A(){return O.apply(null,m.call(arguments).reverse())}function C(t,e){var n=new XMLHttpRequest;n.open("GET",t,!0),n.onreadystatechange=function(){try{var t=n.status;if(n.readyState<4)return;if(200!=t&&n.readyState>3&&"function"==typeof e.err){var r={status:t};try{o(r,JSON.parse(n.responseText))}catch(r){}return e.err(r)}e.ok(JSON.parse(n.responseText))}catch(r){console.error(r),e.err(r)}},n.send()}function j(){var t=[].join.call(arguments,"/");return"/"!==t[0]&&(t="/"+t),T()+"/web/public/native/config"+t}function T(){return("undefined"!=typeof flowplayer?flowplayer:{}).OVP_API||"https://ljsp.lwcdn.com"}function S(t){return~t.indexOf("/")?t:"/media/"+t}var x={404:"media not found",402:"invalid subscription",400:"bad request",415:"unsupported media type"};function L(t,e){var n=i({},t);return e.forEach((function(t){delete n[t]})),n}var N={media_id:"id",media_duration:"duration",media_name:"title",media_tags:"tags",category:"category_name",ad_keywords:"ad_keywords"};var M=["src","metadata","title","description","duration","poster"];function P(t){var e=s(t,"ima.ads");return Array.isArray(e)&&c(t,"ima.ads",e.map((function(e){return"number"==typeof e.percentage&&(e.time=e.percentage*t.duration),e}))),t}function D(t,e){e="object"==typeof e?e:{};var n={title:s(t,"metadata.title",null),description:s(t,"metadata.description",null)};return A({ima:{parameters:function(t,e,n){for(var r in n=n||{},t)n[r]=s(e||{},t[r]);return n}(N,s(t,"metadata",{}))}},n,t,L(e,M),L(e.embed||{},["src"]))}var k=/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/;function I(t){return"object"==typeof t&&"ovp/base64"==t.type}function R(t,e,n){return function(t,e){return!(~t.indexOf(".")||!k.test(t))&&(e.type="video/ovp",!0)}(t,e)||I(e)}function q(t){try{return V(decodeURIComponent(atob(t).split("").map((function(t){return"%"+("00"+t.charCodeAt(0).toString(16)).slice(-2)})).join("")))}catch(t){return{err:t.message}}}function V(t){return null===t?{}:JSON.parse(t)}var U=Object.freeze({__proto__:null,base64:q,json:V});function H(t){var e=t.split(/[^0-9]/);return Date.UTC(e[0],e[1]-1,e[2],e[3],e[4],e[5])}var W=Object.freeze({__proto__:null,OVP_ERROR:"ovp:error",OVP_MEDIA_REQUEST_START:"ovp:request:start",OVP_MEDIA_REQUEST_COMPLETE:"ovp:request:media:complete",OVP_PLAYLIST_REQUEST_COMPLETE:"ovp:request:playlist:complete",LIVE_COUNTDOWN_TICK:"ovp:live:countdown:tick",LIVE_COUNTDOWN_START:"ovp:live:countdown:start",LIVE_COUNTDOWN_COMPLETE:"ovp:live:countdown:complete",OVP_MEDIA_CHANGED:"ovp:media:changed",OVP_REALTIME_MESSAGE:"ovp:message:realtime"});function J(t,e){if(I(e))return F(t,e);p(e).fmap(s,"src").fmap(S).fmap(j).fmap(C,{ok:p.curry(z,[t]),err:p.curry(G,[t])})}function F(t,e){p(e).fmap(s,"src").fmap(p.maybe,q).fmap(p.maybe,p.curry(z,[t]))}function z(t,e){if(t.emit("ovp:media:changed",e),s(e,"playlist"))return B(t,e);if(s(e,"live"))return K(t,e);if(s(e,"src"))return Q(t,e);throw new Error("Status[200] >> unhandled case\n"+JSON.stringify(e,null,2))}function G(t,e){return e.message?t.emit("ovp:error",e):e.status?t.emit("ovp:error",new Error(x[e.status])):t.emit("ovp:error",e)}function Q(t,e){t.emit("ovp:request:media:complete",p.of(e).fmap(D,t.opts).fmap(P).fmap(p.lift))}function B(t,e){if("function"!=typeof flowplayer.playlist)return console.warn("OVP responded with Playlist media but the playlist plugin does not exist"),G(t,{status:415});var n,r,o,a;t.emit("ovp:request:playlist:complete",(n=t.opts,r=e,o=i({},n),i(a=A({},r,s(n,"playlist",{})),{playlist:s(a,"playlist",[]).map((function(t){return D(t,o)}))})))}function K(t,e){var n=s(e,"metadata.live_start_time",s(e,"metadata.starttime"));c(e,"live_start_time",p.of(n).fmap(H).fmap(p.lift)),t.emit("ovp:live:countdown:start",p.of(e).fmap(D,t.opts).fmap(P).fmap(p.lift))}var X={};function Y(t,e){if("object"==typeof X[e])return console.debug("using Cache(%s)",e),Z(t,e,X[e]);p(e).fmap(j).fmap(C,{ok:p.curry(Z,[t,e]),err:console.error})}function Z(t,e,n){"object"!=typeof X[e]&&(X[e]=n);var r=s(t,"opts",{}),o=s(r,"metadata",{});c(o,"player_id",e),["title","description"].forEach((function(t){!0===n[t]&&"string"==typeof r[t]&&c(n,t,s(r,t))})),c(r,"metadata",o);var a=i(r,n);t.setOpts(a),n.autoplay&&t.togglePlay(!0)}var $=Object.freeze({__proto__:null,fetch_unknown_media:J,handle_base64:F,handle_200:z,handle_err:G,handle_single_media:Q,handle_playlist:B,handle_live:K,fetch_player_id:Y,handle_player_only:Z}),tt=void 0;function et(t,e,n){nt()||p.of("recommendation").fmap(j,e,n).fmap(C,{err:rt,ok:p.curry(ot,[t])})}function nt(){return tt}function rt(t){tt=!0,console.error("Failed to load recommendations: %j",t)}function ot(t,e){var n=e.playlist;c(t,"opts.recommendations",n),s(n,"length",0)&&t.emit("recommendationsready",{playlist:n.map((function(t){return{poster:t.poster,src:t.src,title:s(t,"metadata.title"),metadata:t.metadata||{}}}))})}const it=!!function(){let t=!1;try{const e=Object.defineProperty({},"passive",{get:function(){t=!0}});window.addEventListener("testPassive",null,e),window.removeEventListener("testPassive",null,e)}catch(t){}return t}()&&{passive:!0},at=["touchstart","touchmove"];function st(t){var e=t;return e.emit=function(t,n,r={}){const i=function(t){const e=document.createEvent("Event");return e.initEvent(t,!1,!0),e}(t);return n&&o(i,{data:n||{}}),e.dispatchEvent(i),!1===r.return_self?i:e},e.on=function(t,n){return"string"==typeof t&&(t=t.split(" ")),t.forEach((function(t){return function(t){return~at.indexOf(t)}(t)?e.addEventListener(t,n,it):e.addEventListener(t,n)})),e},e.off=function(t,n){return e.removeEventListener(t,n),e},e.one=e.once=function(t,n){return e.on(t,(function r(o){e.off(t,r),n(o)}))},e}const ct=Array.isArray,ut="undefined"!=typeof window&&st(window),lt="undefined"!=typeof document&&st(document),ft=["span","a","em","p","i"];function dt(t,e,n){var r=mt(document.createElement(t));if(ct(e)&&(n=e,e=!1),n||(n=[]),n&&!ct(n)&&(n=[n]),n.length&&n.filter(t=>!!t).forEach(t=>r.append(t)),"object"!=typeof e)return r;for(var o in e)o in r?r[o]=e[o]:r.setAttribute(o,e[o]);return r}function pt(t){var e=t.tagName;t.__flowplayer__=1,t.find=function(e){var n=t.querySelector(e);return n?mt(n):n},t.html=function(e){return t.innerHTML=e,t},t.empty=function(){return t.innerHTML="",t},t.offset=function(){var e={top:0,left:0},n=t;do{e.left+=n.offsetLeft||0,e.top+=n.offsetTop||0}while(n=n.offsetParent);return e},t.innerWidth=function(){var e=getComputedStyle(t);return t.clientWidth-parseFloat(e.paddingLeft)-parseFloat(e.paddingRight)};var r=t.insert=function(e,n){return n?ct(n)?n.map((function(n){return t.insert(e,n)}))[0]:mt(n="string"==typeof n?t.insertAdjacentHTML(e,n):t.insertAdjacentElement?t.insertAdjacentElement(e,n):t.appendChild(n)):n};return t.append=r.bind(t,"beforeend"),t.prepend=r.bind(t,"afterbegin"),t.css=function(e,n){if("object"==typeof e){for(const n in e)t.css(n,e[n]);return t}return void 0===n&&"string"==typeof e?getComputedStyle(t)[e]:("number"==typeof n&&(n+="px"),t.style[e]=n,t)},t.show=function(){return t.css({display:~ft.indexOf(e)?"inline":"block"})},t.hide=function(){return t.css({display:"none"})},t.remove=function(){var e=t.parentNode;e&&e.removeChild(t)},t.attr=function(e,n){return null==n?t.getAttribute(e):(t.setAttribute(e,n),t)},t.txt=function(e){return t.textContent=e,t},t.fp=function(e){return t.addClass("fp-"+e)},t.addClass=function(e){return e.split(" ").forEach((function(e){t.hasClass(e)||(t.className+=(t.className?" ":"")+e)})),t},t.removeClass=function(e){const n=e.split(" ");var r=t.className.split(" ");return t.className=r.filter((function(t){return!~n.indexOf(t)})).join(" "),t},t.toggleClass=function(e,n){return void 0===n&&(n=!t.hasClass(e)),n?t.addClass(e):t.removeClass(e)},t.findAll=function(e){return r=t.querySelectorAll(e),n.call(r);var r},t.hasClass=function(e){return~t.className.split(" ").indexOf(e)},t}function mt(t){return void 0===t||function(t){return t&&t.__flowplayer__}(t)?t:pt(st(t))}function vt(t,e){if("string"==typeof t&&"<"==t[0])return dt(t.slice(1,-1),e);if("string"!=typeof t)return mt(t);var n=e instanceof HTMLElement&&e.querySelector(".fp-"+t)||document.querySelector(t);return n?mt(n):void 0}const yt=t=>(e,n)=>("string"==typeof e&&(e={class:e}),dt(t,e,n));function ht(t,e,n){if(!gt(t))return n.emit("ovp:request:media:complete",t);var o=e.append(vt.div({class:"fp-livecountdown"})),i=o.append(vt.div({class:"fp-inner"}));i.append(vt.p({},n._t("ovp.starting_in")));var a=i.append(vt.p({class:"fp-countdown"}));function c(t){var r=s(t,"data.remaining",-1);if(r<0||isNaN(r))return n.emit("ovp:live:countdown:complete");e.addClass("is-livecountdown"),a.txt(function(t){var e=function(t){"number"!=typeof t&&(t=parseInt(t,10)),t=Math.round(t);var e=Math.floor(t/86400);t-=86400*e;var n=Math.floor(t/3600);t-=3600*n;var r=Math.floor(t/60);return{days:e,hours:n,minutes:r,seconds:t-=60*r}}(t),n="";e.days&&(n+=e.days+":");return n+u(e.hours)+":"+u(e.minutes)+":"+u(e.seconds)}(r+1)),n.hasState("is-starting")||n.setState("is-starting",!0)}n.on("ovp:live:countdown:tick",c),n.one("ovp:live:countdown:complete",(function(){o.remove(),e.removeClass("is-livecountdown"),n.off("ovp:live:countdown:tick",c),n.emit("ovp:request:media:complete",t)})),function(t,e){var n;function o(){return t=e.live_start_time,n=s(e,"server_time_offset",0),r=Date.now()-n,Math.floor((t-r)/1e3);var t,n,r}function i(){var e=o();t.emit("ovp:live:countdown:tick",{remaining:e}),(e<0||0===t.reaper)&&clearInterval(n)}a=e,c={err:console.error,ok:r},C(T()+"/web/public/countdown/time.json",{err:c.err,ok:function(t){var e=Date.now()-t.millisUtc;c.ok(E(a,{server_time_offset:e}))}}),i(),n=setInterval(i,250);var a,c}(n,t)}function _t(t,e,n){}function gt(t){return t&&t.live_start_time-Date.now()>0}Object.assign(vt,{div:yt("div"),img:yt("img"),li:yt("li"),ol:yt("ol"),span:yt("span"),p:yt("p"),i:yt("i"),a:yt("a"),el:dt,document:lt,window:ut});function wt(t,e,n){var r="flowplayer-ovp-branding-"+e;if(!t.hasClass(r)){!function(t){if(-1==t.className.indexOf("flowplayer-ovp-branding-"))return;t.className=t.className.split(" ").filter((function(t){return-1==t.indexOf("flowplayer-ovp-branding-")})).join(" ")}(t);var o=function(t){if(document.getElementById(t))return!1;var e=document.createElement("style");return e.id=t,e.appendChild(document.createTextNode("")),document.head.appendChild(e),e.sheet}(r);o&&(!function(t,e,n,r){if("insertRule"in t)return t.insertRule(e+"{"+n+"}",r);if("addRule"in t)t.addRule(e,n,r)}(o,"."+r+" .fp-color","background-color: #"+n+";"),t.addClass(r))}}class bt{constructor(t){this.manualDisconnect=!1,this.video=t,this.onClose=this.onClose.bind(this),this.onMessage=this.onMessage.bind(this)}static of(t){return new bt(t)}connect(t){this.client=new WebSocket("wss://player.ws.flowplayer.com?mediaId="+t),this.current_media_id=t,this.wireup()}onClose(){this.manualDisconnect?this.manualDisconnect=!1:this.current_media_id&&this.reconnect(this.current_media_id)}onMessage(t){const e=JSON.parse(t.data);for(const t of e)this.video.emit("ovp:message:realtime",t)}reconnect(t){this.cleanup(),this.connect(t)}wireup(){this.client&&(this.client.addEventListener("message",this.onMessage),this.client.addEventListener("close",this.onClose))}cleanup(){this.client&&(this.client.removeEventListener("message",this.onMessage),this.client.removeEventListener("close",this.onClose),this.client=void 0)}disconnect(){this.client&&(this.manualDisconnect=!0,this.client.close())}}function Et(t,n,r,a){var c=new bt(r),u=i({},t),l=function(t){if(!u)return t;delete u.src;var n=e(t,u);return u=0,n};if(4==arguments.length&&"object"==typeof a)return"string"!=typeof t.player_id||0===a.src.indexOf(t.player_id)||I(a)||(a.src=[t.player_id,a.src].join("/")),J(r,a);r.on("ovp:error",(function(t){r.emit("error",t.data)})),r.on("ovp:request:start",(function(){r.setState("is-waiting",!0),t.recommendations&&(t.recommendations=1)})),r.on("ovp:media:changed",(function(t){if(s(t,"data.live")){var e=s(t,"data.metadata.media_id");c.disconnect(),c.connect(e)}})),r.on("ovp:message:realtime",(function(e){var n=s(e,"data.event"),i=s(e,"data.value");switch(n){case"METADATA":var a=o(t,{metadata:o(s(r,"opts.metadata",{}),i)});a.live&&s(a,"metadata.live_start_time")&&(a.live_start_time=H(a.metadata.live_start_time)),r.setOpts(a)}})),r.on("beforeplay",(function(e){Ot(t)||e.preventDefault()})),r.on("ovp:request:media:complete",(function(t){if(0!=r.reaper&&"object"==typeof t.data&&!gt(t.data)){var e=l(t.data);r.setOpts(e),r.setAttrs(e),r.setSrc(e.src),e.autoplay&&r.togglePlay(!0,(function(){setTimeout(r.setState,0,"is-seamless",!1)}))}})),r.on("config",(function(e){var o=s(e,"data.brand_color"),i=s(e,"data.metadata.player_id");if(o&&i&&wt(n,i,o),!("string"==typeof t.src&&R(t.src,{})||t.src&&t.src.length&&"ovp/base64"===t.src[0].type))return"string"==typeof t.player_id&&s(t,"metadata.player_id")!==t.player_id?Y(r,t.player_id):void 0})),r.on("ovp:request:playlist:complete",(function(t){if(0!=r.reaper&&"object"==typeof t.data){var e=l(t.data);flowplayer.playlist(n,e)}})),r.on("ovp:live:countdown:start",(function(e){if(0!=r.reaper&&"object"==typeof e.data){var o=l(e.data);r.setOpts(o),r.setAttrs(o),r.render("live/countdown",[t,n,r])}})),r.on("timeupdate",(function(){t.live?Ot(t)||(r.togglePlay(!1),r.emit("ended")):t.recommendations&&s(t,"metadata.media_id")&&(Array.isArray(t.recommendations)||r.currentTime/r.duration<.8||nt()||et(r,s(t,"metadata.media_id"),s(t,"metadata.player_id")))})),r.on("reap",(function(){c.disconnect()}))}function Ot(t){var e=s(t,"metadata.live_stop_time",!1);return!e||s(t,"metadata.allow_after_stop_time",!0)||H(e)>Date.now()}return Et.onumd=function(t){t.components.put("live/countdown",{onrender:ht,onremove:_t})},Et.wants=R,function(t,e){if("object"==typeof exports&&"undefined"!=typeof module)return e;"flowplayer"in t||(t.flowplayer={extensions:[]});var n=t.flowplayer;"function"==typeof n?n(e):(Array.isArray(n.extensions)||(n.extensions=[]),~n.extensions.indexOf(e)||n.extensions.push(e))}("undefined"!=typeof window?window:"undefined"!=typeof global?global:{},o(Et,{events:W,Decode:U,Loader:$})),Et}));
