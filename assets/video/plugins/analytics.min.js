!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):((e="undefined"!=typeof globalThis?globalThis:e||self).flowplayer=e.flowplayer||{},e.flowplayer.analytics=t())}(this,(function(){"use strict";var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function t(e){var t={exports:{}};return e(t,t.exports),t.exports}var n=t((function(t,n){var r=e&&e.__assign||function(){return(r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};n.__esModule=!0,n.remove=n.downcase=n.pluck=n.merge=void 0,n.merge=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return e.reduce((function(e,t){return r(r({},e),t)}),{})},n.pluck=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];return Object.keys(e).filter((function(e){return~t.indexOf(e)})).reduce((function(t,r){var i;return n.merge(t,((i={})[r]=e[r],i))}),{})},n.downcase=function(e){return(e||"").toString().toLowerCase()},n.remove=function(e,t){var n=e.lastIndexOf(t);return~n&&e.splice(n,1),e}})),r=t((function(t,r){var i=e&&e.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=e&&e.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=e&&e.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.hasOwnProperty.call(e,n)&&i(t,e,n);return o(t,e),t};r.__esModule=!0;var u=a(n),c=function(){function e(){this.pending=[],this.open=[],this.stats={failures:0,ttl:0}}return e.of=function(){return new e},e.is_empty=function(e){return 0==e.pending.length},e.is_high_water=function(t){return t.open.length==e.MAX_OPEN_REQUESTS},e.maybe_spawn_req=function(t){if(e.is_empty(t))return t;if(e.is_high_water(t))return t;try{var n=e.lpop(t);n&&e.request(t,n)}catch(e){}},e.increment_failures=function(t){return t.stats.failures++,t.stats.failures>e.MAX_FAILURE_COUNT&&(t.stats.ttl=Date.now()+e.REQUEST_TTL_MS),t},e.handle_error=function(t,n){e.rm(t,n),e.increment_failures(t)},e.request=function(t,n){var r=n[0],i=n[1],o=n[2];if(!(Date.now()<t.stats.ttl)){var a=new XMLHttpRequest;t.open.push(a),a.timeout=e.REQUEST_TIMEOUT_MS,a.ontimeout=function(){e.handle_error(t,a)},a.onerror=function(n){e.handle_error(t,a)},a.onreadystatechange=function(){a.readyState==XMLHttpRequest.DONE&&e.rm(t,a),Math.floor(a.status/100)},a.onload=function(){e.rm(t,a),t.stats.failures&&t.stats.failures--},a.open(i,r),a.setRequestHeader("Content-Type","text/plain;charset=UTF-8");try{a.send(JSON.stringify(o))}catch(e){}}},e.rpush=function(t){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];return n.forEach((function(n){t.pending.length>=e.MAX_PENDING||(t.pending.push(n),e.maybe_spawn_req(t))})),t},e.lpop=function(e){return e.pending.shift()},e.rm=function(e,t){return u.remove(e.open,t),e},e.MAX_OPEN_REQUESTS=3,e.MAX_PENDING=5,e.REQUEST_TIMEOUT_MS=4e3,e.REQUEST_TTL_MS=5e3,e.MAX_FAILURE_COUNT=3,e}();r.default=c})),i=t((function(t,n){var i=e&&e.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};n.__esModule=!0;var o=i(r);n.default=o.default.of()})),o=t((function(e,t){t.__esModule=!0,t.prepare_url=t.URL_PARAM=void 0,t.URL_PARAM=/:([a-zA-Z_]+)/g,t.prepare_url=function(e,n){return e.url.replace(t.URL_PARAM,(function(t){if((t=t.slice(1,t.length))in n)return n[t].toString();e.log.error(new Error("\n      preparing url["+e.url+"] failed\n      \n      parameter["+t+"] not detected in params:\n      \n      "+JSON.stringify(n,null,2)+"\n    "))}))}})),a=t((function(e,t){t.__esModule=!0,t.Log=void 0;var n=function(){function e(e){this.emitter=e}return e.prepare=function(e,t){var n=document.createEvent("Event");return n.initEvent(e,!1,!0),n.ns=e,n.data=t,n},e.of=function(t){return new e(t)},e.prototype.info=function(t){this.emitter.dispatchEvent(e.prepare(e.NAMESPACE.INFO,t))},e.prototype.error=function(t){this.emitter.dispatchEvent(e.prepare(e.NAMESPACE.ERROR,t))},e.prototype.warn=function(t){this.emitter.dispatchEvent(e.prepare(e.NAMESPACE.WARN,t))},e.NAMESPACE={INFO:"tracker:info",ERROR:"tracker:err",WARN:"tracker:warn"},e}();t.Log=n})),u=t((function(e,t){var n;t.__esModule=!0,t.Verb=void 0,(n=t.Verb||(t.Verb={})).POST="POST",n.PUT="PUT",n.GET="GET"})),c=t((function(t,c){var s=e&&e.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),d=e&&e.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),f=e&&e.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.hasOwnProperty.call(e,n)&&s(t,e,n);return d(t,e),t},l=e&&e.__spreadArrays||function(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;var r=Array(e),i=0;for(t=0;t<n;t++)for(var o=arguments[t],a=0,u=o.length;a<u;a++,i++)r[i]=o[a];return r},p=e&&e.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};c.__esModule=!0;var _=p(i),v=p(r),h=f(o),m=f(n),y=function(){function e(t,n){var r=this;void 0===n&&(n={});var i=this;if(this.emitter=t,this.url=n.url,this.log=a.Log.of(this.emitter),this.verb=n.verb,this.metadata=m.merge({},n.metadata||{}),this.rq=n.rq||_.default,this.events=n.events||[],this.required_keys=n.required_keys||[],this.optional_keys=n.optional_keys||[],this.listeners=[],this.valid_keys=this.required_keys.slice(0).concat(this.optional_keys),e.assert_emitter_api(this.emitter),void 0===e.verb[this.verb])throw new Error("invalid HTTP verb["+this.verb+"] passed");if("string"!=typeof this.url)throw new Error("invalid API url["+this.url+"] passed");e.TRACKERS.push(this),i.events.forEach((function(t){e.create_listener(r,t,(function(n){void 0===n&&(n={});var o=m.merge(i.metadata,{event_type:t},n.data||n),a=h.prepare_url(i,o),u=e.pluck_valid_keys(i,o),c=e.ensure_required_keys(i,u);if(c.length)return i.log.error("Tracker.validate_metadata() failed for \n            Event["+t+"]\n            missing keys: "+c+"\n            payload:\n              "+JSON.stringify(u,null,2));v.default.rpush(r.rq,[a,r.verb,u])}))}))}return e.of=function(t,n){return new e(t,n)},e.ensure_required_keys=function(e,t){return e.required_keys.filter((function(e){return!(e in t)}))},e.pluck_valid_keys=function(e,t){return m.pluck.apply(m,l([t],e.valid_keys))},e.merge_metadata=function(t,n){return void 0===n&&(n={}),t.metadata=e.pluck_valid_keys(t,m.merge(t.metadata,n)),t},e.assert_emitter_api=function(e){if("function"!=typeof(e||{}).addEventListener)throw new Error("Tracker() received an emitter that does not implement the addEventListener method");if("function"!=typeof(e||{}).removeEventListener)throw new Error("Tracker() received an emitter that does not implement the removeEventListener method")},e.create_listener=function(e,t,n){e.listeners.push([t,n]),e.emitter.addEventListener(t,n)},e.prototype.destroy=function(){var t=this;this.listeners.forEach((function(e){var n=e[0],r=e[1];return t.emitter.removeEventListener(n,r)})),delete this.rq,delete this.emitter,m.remove(e.TRACKERS,this)},e.prototype.put=function(t){return void 0===t&&(t={}),e.merge_metadata(this,t),this},e.TRACKERS=[],e.QUEUE=_.default,e.verb=u.Verb,e}();c.default=y})),s=t((function(t,n){var r=e&&e.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),i=e&&e.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=e&&e.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.hasOwnProperty.call(e,n)&&r(t,e,n);return i(t,e),t},u=e&&e.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};n.__esModule=!0,n.API=n.Tracker=void 0;var s=u(c);n.Tracker=s.default;var d=a(o);n.API=d})),d=Object.freeze({__proto__:null,ADS:2,ANALYTICS:4,NO_METERING:8,DEVELOPER_PLAN:16}),f=["localhost","127.0.0.1","0.0.0.0","s.codepen.io","cdpn.io"];function l(e,t){return!!~f.indexOf(e)||e.indexOf(t)===e.length-t.length}l.check_whitelist=function(e){return!!~f.indexOf(e)};function p(e){this.message=e}p.prototype=new Error,p.prototype.name="InvalidCharacterError";var _="undefined"!=typeof window&&window.atob&&window.atob.bind(window)||function(e){var t=String(e).replace(/=+$/,"");if(t.length%4==1)throw new p("'atob' failed: The string to be decoded is not correctly encoded.");for(var n,r,i=0,o=0,a="";r=t.charAt(o++);~r&&(n=i%4?64*n+r:r,i++%4)?a+=String.fromCharCode(255&n>>(-2*i&6)):0)r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(r);return a};var v=function(e){var t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw"Illegal base64url string!"}try{return function(e){return decodeURIComponent(_(e).replace(/(.)/g,(function(e,t){var n=t.charCodeAt(0).toString(16).toUpperCase();return n.length<2&&(n="0"+n),"%"+n})))}(t)}catch(e){return _(t)}};function h(e){this.message=e}h.prototype=new Error,h.prototype.name="InvalidTokenError";var m=function(e,t){if("string"!=typeof e)throw new h("Invalid token specified");var n=!0===(t=t||{}).header?0:1;try{return JSON.parse(v(e.split(".")[n]))}catch(e){throw new h("Invalid token specified: "+e.message)}};function y(e,t){var n={};t=t||{};try{n=m(e),this.valid_jwt=!0}catch(e){}this.raw=e,this.data=JSON.parse(n.c||"{}"),this.exp=n.exp,t.require_valid_token&&y.validate(this)}m.InvalidTokenError=h,y.validate=function(e){if("string"==typeof e&&(e=new y(e)),!e||!e.raw){if(l.check_whitelist(window.location.hostname))return!0;throw new Error("No token provided in configuration")}if(!e.valid_jwt)throw new Error("Invalid token provided");var t=window.location.hostname,n=l.bind(null,t);if(e.data.domain&&e.data.domain.length&&!e.data.domain.some(n))throw new Error("Domain not allowed");if(1e3*e.exp-Date.now()<0)throw new Error("Expired token");return!0},y.id=function(e){if(e)return"string"==typeof e&&(e=new y(e)),e.data.id};var g={};for(var w in d)g[d[w]]=w;function k(e){if(!(this instanceof k))return new k(e);var t=this;t.grant=e,t.is_granted=function(e){return(t.grant&e)===e}}function E(e,t,n){const r=function(e){return Array.isArray(e)?e.slice(0):e.split(".")}(t);for(;r.length;){if(null==e)return n;const t=r.shift();if("string"!=typeof t)return n;e=e[t]}return null==e?n:e}k.of=k,k.from_token=function(e){var t=new y(e,{require_valid_token:!0});return k.of(t.data.acl)},k.permissions=d;var b="ping",T="display",O="view";var A={3:!0,5:!0,7:!0,9:!0};var M=function(e){for(var t,n=0;n<16;n++)0==(3&n)&&(t=4294967296*Math.random()),e[n]=t>>>((3&n)<<3)&255;return e}(Array(16)).reduce((function(e,t,n){var r=(t+256).toString(16).substr(1);return e+(A[n]?"-":"")+r}),""),S=["sitegroup_id","session_id","media_id","site_id","player_id","video_type"],R=["created","position"],x=["player_version","created","source","category","category_id","autoplay","muted","customer_user_id"];function P(e,t,n){if(!(this instanceof P))return new P(e,t,n);var r=this;return r.name=e.name||"RL::anonymous::"+Date.now(),r.locked=!1,r.ttl=t,r.unlock=function(){return r.locked=!1,r},r.run=function(){r.locked||(r.locked=setTimeout((function(){return e.apply(null,n),r.unlock()}),t))},r.cancel=function(){return r.locked&&clearTimeout(r.locked),r.unlock()},r}function N(e,t,n){if(!(this instanceof N))return new N(e,t,n);var r=this;r.last_idx=0,r.segment_duration=0,r.breakpoints=[],r.calculate_segment_info=function(){return t.duration/1===t.duration&&function(...e){return e.slice(1).reduce((e,t)=>function(e,t,...n){for(const n in t)e[n]=t[n];return e}(e,t),e[0]||{})}(r,N.segment_info(t.duration))},r.run=function(e){if(r.segment_duration||r.calculate_segment_info()){var n=N.select_watched_segments(r,t,e);0!=n.length&&t.emit(b,{position:n})}},r.update=function(){r.calculate_segment_info(),r.last_idx=N.next_idx(r,t)}}N.segment_info=function(e){var t=e/100;return{segment_duration:t,breakpoints:Array.apply(null,Array(100)).map((function(e,n){return Math.floor(n*t*1e3)/1e3}))}},N.next_idx=function(e,t){return Math.min(Math.floor(t.currentTime/e.segment_duration),99)},N.select_watched_segments=function(e,t,n){var r=e.last_idx,i=n?99:N.next_idx(e,t);return e.last_idx=i,i<=r?[]:e.breakpoints.slice(r,99==i?100:i).map((function(t){return e.breakpoints.indexOf(t)}))};function I(e,t,n){if(!(this instanceof I))return new I(e,t,n);var r=this;r.last_tracked_ts=Date.now(),r.ticks=0,r.run=function(){var e=Date.now();e-r.last_tracked_ts<6e4||(r.last_tracked_ts=e,++r.ticks,t.emit(b,{position:60*r.ticks}))},r.update=function(){}}I.within=function(e,t,n){var r=e+t.right,i=e-t.left;return n<r&&n>i};var L="vod",j="live",q=[T,b,O];function U(e){var t=e.ads;return void 0!==t&&(void 0!==t.schedule&&("function"==typeof t.hasPreroll&&(t.currentRequests?t.currentRequests:!!t.adPlaying||!(!t.hasPreroll()||0!=t.nextIndex))))}function C(){try{return window.location!==window.parent.location?document.referrer:document.location.href}catch(e){return!1}}var D=function(e,t){if("object"==typeof exports&&"undefined"!=typeof module)return t;"flowplayer"in e||(e.flowplayer={extensions:[]});var n=e.flowplayer;return"function"==typeof n?(n(t),t):(Array.isArray(n.extensions)||(n.extensions=[]),~n.extensions.indexOf(t)||n.extensions.push(t),t)}("undefined"!=typeof window?window:"undefined"!=typeof global?global:{},(function(e,t,n){if(k.from_token(e.token).is_granted(k.permissions.ANALYTICS)&&!n.analytics){var r=n.analytics={ticker:void 0,last_media_id:void 0,ping:function(){r.ticker&&r.ticker.run()},comp:P((function(){r.ping()}),6e3),ended:void 0},i={session_id:M,autoplay:n.autoplay,muted:n.muted,player_id:e.player_id,customer_user_id:e.customer_user_id},o=n.analytics.tracker=s.Tracker.of(n,{verb:s.Tracker.verb.POST,url:"https://ptm.flowplayer.com/:video_type/:sitegroup_id/:event_type",events:q,required_keys:S,optional_keys:[].concat(x).concat(R),metadata:i,video_type:e.live?j:L});n.on("reap",(function(){o&&o.destroy(),o=0})),n.on("config",(function(t){if(o){var i=E(t,"data.metadata",{});if(i.media_id){var a=E(o,"metadata.media_id");if(!a||i.media_id!=a){var u=E(e,"analytics",{});o.put(i),o.put(u);var c=E(e,"metadata.live_start_time",e.live)?j:L;o.put({video_type:c,source:e.source||C()||""}),r.ticker=e.live?I(r,n,o):N(r,n,o),r.ended=!1,n.emit(T)}}}}));var a=void 0;n.on("playing",(function(){if(o&&!a&&!function(e,t){return e.metadata.media_id&&e.metadata.media_id==t.last_media_id}(o,r)){o.put({muted:n.muted});var e=U(n);if(e)return a=function(e,t,n){if(e&&"function"==typeof e.then){var r=e.then(t);if("function"!=typeof n)return r;r.catch(n)}}(e,(function(){r.last_media_id=o.metadata.media_id,n.emit(O),a=void 0}),(function(){a=void 0}));r.last_media_id=o.metadata.media_id,n.emit(O)}})),n.on("timeupdate",(function(){o&&(a||U(n)||r.ended||(!e.live&&n.currentTime+.25>=n.duration&&r.ticker&&r.ticker.run(!0),r.comp.run()))})),n.on("seeked",(function(){o&&r.ticker&&r.ticker.update()})),n.on("ended",(function(){o&&function(e){e.ended||(e.ended=!0,e.comp.cancel(),e.ping())}(r)}))}}));return D.Tracker=s.Tracker,D}));
