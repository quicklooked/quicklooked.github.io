!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):((t="undefined"!=typeof globalThis?globalThis:t||self).flowplayer=t.flowplayer||{},t.flowplayer.health=n())}(this,(function(){"use strict";function t(...t){return t.slice(1).reduce((t,n)=>function(t,n,...e){for(const e in n)t[e]=n[e];return t}(t,n),t[0]||{})}function n(t,n,e){const i=function(t){return Array.isArray(t)?t.slice(0):t.split(".")}(n);for(;i.length;){if(null==t)return e;const n=i.shift();if("string"!=typeof n)return e;t=t[n]}return null==t?e:t}var e=Date.now(),i={session_id:Math.random().toString(36).substring(2)+performance.now().toString(36)};class r{constructor(){this._summary={},this._session_id=i,this.start_time=e}increment(t,n){if("string"==typeof t&&"number"==typeof n){var e=this._summary[t]||0;this._summary[t]=e+n}}set(t,n){"string"==typeof t&&(this._summary[t]=n)}duration(){return Date.now()-this.start_time}summary(n){return t("object"==typeof n?n:{},{event:"health_summary"},this._summary,this._session_id,{duration:this.duration()})}sessionize(n){return t(n,this._session_id)}}function o(t,n){return function(t,n){return"function"==typeof navigator.sendBeacon&&navigator.sendBeacon(t,n)}(t,JSON.stringify({events:n}))}class a{constructor(t){this.middleware=t,this._pending=[]}pending(){return this._pending}_run_middleware(n,e){return n=t({},n),this.middleware.forEach((function(i){var r=i(e);if("object"==typeof r)return t(n,r);console.warn("KPI::middleware did not return an Object\nreturn: %o\n\nfn: %s",r,i)})),n}push(t,n){t=this._run_middleware(t,n),this.push_finalized(t)}push_finalized(t){this._pending.push(t),this.send()}send(t){if(!(this._pending.length<20)||t){var n=this._pending.slice(0);this._pending.length=0,o("https://health.flowplayer.com/v1/health/events",n)}}}function s(){return n(window,"navigator.connection.downlink")}function u(t){const n=t.hls;if(!n)return;const e=n.abrController._bwEstimator;return e?.001*e.getEstimate():void 0}function d(t){const n=[u,s];for(;n.length;){const e=n.shift(),i="function"==typeof e&&e(t);if("number"==typeof i)return{downlink_mbs:Number(i.toFixed(2))}}return{}}const f=document.createElement("a");function c(t){var n=t.original_src;return"string"!=typeof n?{}:(f.href=n,"string"==typeof f.pathname?{media_type:f.pathname.split(".").pop()}:{})}function l(t){return{preload:t.opt("preload"),autoplay:t.opt("autoplay",t.autoplay)}}function p(t){return{player_id:t.opt("metadata.player_id"),media_id:t.opt("metadata.media_id"),site_id:t.opt("metadata.site_id"),category_id:t.opt("metadata.category_id"),sitegroup_id:t.opt("metadata.sitegroup_id"),token:t.token}}function h(){return{timestamp:Date.now()}}function m(){return{ua:navigator.userAgent,version:"2.9.6",commit:"c21973731e50f047756ebba96e9d958593a2fa2e"}}var y=["error","rebuffer"],_=y.concat(["load","loadstart","loadedmetadata","loadeddata","error:fatal","playing","seeked","quality:set","pause","ended","seeking"]);let g=!1;function w(n,e,i){n.push_finalized(t(e.summary({}),l(i),p(i),h(),m())),n.send(!0)}function v(t){try{return!!new URL(t)}catch(t){return!1}}return function(t,n){if("object"==typeof exports&&"undefined"!=typeof module)return n;"flowplayer"in t||(t.flowplayer={extensions:[]});var e=t.flowplayer;return"function"==typeof e?(e(n),n):(Array.isArray(e.extensions)||(e.extensions=[]),~e.extensions.indexOf(n)||e.extensions.push(n),n)}(window,(function(t,n,e){if(!e._health){var i;g||(i=this,g=!0,window.addEventListener("unload",(function(){i&&"function"==typeof i&&Array.isArray(i.instances)&&i.instances.forEach(t=>t.emit("unload"))})));var o=e._health=new r,s=e._kpis=new a([c,l,p,d,h,m]);y.forEach(t=>{o.set(t,0)}),function(t){t.on("waiting",(function(n){t.seeking||t.networkState===t.NETWORK_LOADING&&t.readyState!==t.HAVE_NOTHING&&t.emit("rebuffer")}))}(e),e.on("reap",(function(){s.send(),e._kpis=e._health=void 0})),e.on("health:summary:increment",(function(t){for(var n in t.data)o.increment(n,t.data[n])})),e.on("health:summary:set",(function(t){for(var n in t.data)o.set(n,t.data[n])})),e.on(y,(function(t){setTimeout(()=>{t.defaultPrevented||e.emit("health:summary:increment",{[t.type]:1})})})),e.on(_,(function(t){setTimeout(()=>{t.defaultPrevented||e.emit("health:kpi:track",{event:t.type})},0)})),e.on("health:kpi:track",(function(t){const n=o.sessionize(t.data);s.push(n,e)})),e.on("src",(function(t){const n=t.data&&t.data.src;"string"==typeof n&&v(e.original_src)&&v(n)&&n!=e.original_src&&w(s,o,e)})),e.on("unload",(function(){w(s,o,e)}))}}))}));
