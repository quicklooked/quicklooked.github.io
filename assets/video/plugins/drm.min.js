!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):((e="undefined"!=typeof globalThis?globalThis:e||self).flowplayer=e.flowplayer||{},e.flowplayer.drm=t())}(this,(function(){"use strict";function e(...e){return e.slice(1).reduce((e,t)=>function(e,t,...n){for(const n in t)e[n]=t[n];return e}(e,t),e[0]||{})}function t(e,t,n){const r=function(e){return Array.isArray(e)?e.slice(0):e.split(".")}(t);for(;r.length;){if(null==e)return n;const t=r.shift();if("string"!=typeof t)return n;e=e[t]}return null==e?n:e}var n="com.widevine.alpha",r="com.microsoft.playready",s="org.w3.clearkey",a="com.apple.fps.1_0",i=Object.freeze({__proto__:null,WIDEVINE:n,PLAYREADY:r,CLEARKEY:s,FAIRPLAY:a,LICENSE_SERVER:"license_server",KEY:"key",KEY_ID:"kid",HTTP_HEADERS:"http_headers",QUERY_PARAMS:"query_params",CERTIFICATE:"certificate",VENDOR:"vendor",REQUEST_MEDIA_KEY_SYSTEM_ACCESS_FUNCTION:"request_media_key_system_access_function"});function o(e){var t={};return Object.keys(e).forEach((function(r){var s;s=r,[n].filter((function(e){return e===s})).length&&function(e,t,r){if(e===n){r.widevineLicenseUrl=t[e].license_server,r.emeEnabled=!0;var s=t[e].http_headers;t[e].request_media_key_system_access_function&&(r.requestMediaKeySystemAccessFunc=t[e].request_media_key_system_access_function),s&&(r.licenseXhrSetup=function(e){Object.keys(s).forEach((function(t){e.setRequestHeader(t,s[t])}))})}}(r,e,t)})),t}function f(e){var t={};return Object.keys(e).forEach((function(a){var i;i=a,[n,r,s].filter((function(e){return e===i})).length&&(t[a]=function(e,t){var n={serverURL:t[e].license_server};return t[e].http_headers&&(n.httpRequestHeaders=t[e].http_headers),n}(a,e))})),t}var c=Object.freeze({__proto__:null,fairplay_fetch_certificate:function(e,t){var n=new XMLHttpRequest;n.responseType="arraybuffer",n.addEventListener("load",(function(){t(new Uint8Array(n.response))}),!1),n.open("GET",e,!0),n.send()},fairplay_request_license:function(e,t,n){var r=new XMLHttpRequest;r.responseType="arraybuffer",r.addEventListener("load",(function(){r.status>=400||n(new Uint8Array(r.response))}),!1),r.open("POST",e+t.assetId+"?"+function(e){return Object.keys(e).map((function(t){return[t,encodeURIComponent(e[t])].join("=")})).join("&")}(t.queryParams),!0),r.setRequestHeader("Content-type","application/octet-stream"),r.send(t.message)}});var u=Object.freeze({__proto__:null,fairplay_fetch_certificate:function(e,t){var n=new XMLHttpRequest;n.responseType="arraybuffer",n.addEventListener("load",(function(){t(new Uint8Array(n.response))}),!1),n.open("GET",e,!0),n.send()},fairplay_request_license:function(e,t,n){var r,s,a=new XMLHttpRequest;a.addEventListener("load",(function(){var e,t,r;a.status>=400||n((e=a.response,t=atob(e),r=new Uint8Array(t.length),Array.prototype.forEach.call(t,(function(e,t){r[t]=e.charCodeAt(0)})),r))}),!1),a.open("POST",e,!0),Object.keys(t.headers||{}).forEach((function(e){a.setRequestHeader(e,t.headers[e])})),a.send("assetid="+encodeURIComponent(t.assetId)+"&spc="+(r=t.message,s=Array.prototype.map.call(r,(function(e){return String.fromCharCode(e)})).join(""),btoa(s)))}}),d=Object.freeze({__proto__:null,ezdrm:c,buydrm:u});function p(e,t,n){if(!t[a])return;if(e.src&&0===e.src.indexOf("blob:"))return;const r=t[a].vendor||"ezdrm",s="string"==typeof r?d[r]:r;s.fairplay_fetch_certificate(t[a].certificate,(function(r){e.webkitSetMediaKeys(new WebKitMediaKeys("com.apple.fps.1_0"));var i=n.initData,o=function(e){var t=(n=e,r=new Uint16Array(n.buffer),String.fromCharCode.apply(null,r));var n,r;return t.substring(t.indexOf("skd:")+6).split(";").pop()}(i);i=function(e,t,n){"string"==typeof t&&(t=function(e){for(var t=new ArrayBuffer(2*e.length),n=new Uint16Array(t),r=0,s=e.length;r<s;r++)n[r]=e.charCodeAt(r);return n}(t));var r=0,s=new ArrayBuffer(e.byteLength+4+t.byteLength+4+n.byteLength),a=new DataView(s);new Uint8Array(s,r,e.byteLength).set(e),r+=e.byteLength,a.setUint32(r,t.byteLength,!0),r+=4;var i=new Uint16Array(s,r,t.length);return i.set(t),r+=i.byteLength,a.setUint32(r,n.byteLength,!0),r+=4,new Uint8Array(s,r,n.byteLength).set(n),new Uint8Array(s,0,s.byteLength)}(i,o,r);var f=e.webkitKeys.createSession("application/x-mpegurl",i);f.addEventListener("webkitkeyerror",console.debug.bind(console,"webkitkeyerror")),f.addEventListener("webkitkeymessage",(function(e){s.fairplay_request_license(t[a].license_server,{message:e.message,assetId:o,headers:t[a].http_headers||{},queryParams:t[a].query_params||{}},(function(e){f.update(e)}))}))}))}function y(n,r,s){s.on("config",(function(e){n=e.data})),s.on("src",(function(r){if(r.data.drm){var a=t(n,"hls",{}),i=r.data.drm?o(r.data.drm):{};s.setOpts({hls:e(a,i)}),s.on("webkitneedkey",p.bind(null,s,r.data.drm||{}));var c=t(n,"dash",{}),u=r.data.drm?f(r.data.drm):{};s.setOpts({dash:e(c,{drm:u})})}}))}return e(y,i),function(e,t){if("object"==typeof exports&&"undefined"!=typeof module)return t;"flowplayer"in e||(e.flowplayer={extensions:[]});var n=e.flowplayer;"function"==typeof n?n(t):(Array.isArray(n.extensions)||(n.extensions=[]),~n.extensions.indexOf(t)||n.extensions.push(t))}(window,y),y}));
